---
title: "2011 and 2016 Census of Housing and Population Exploratory Analysis"
date: "21 April 2018"
output: html_document
---

```{r setup, include=FALSE}

library(psych)
library(plyr)
library(data.table)

setwd("D:/Education/2015-2018 - Master of Data Science/2018-S1 - Data Science Professional Development 2/AustraliaKidneyDisease")

source("functions.R")

```

## Overview

The following code imports data from the 2011 and 2016 Census of Housing and Population for Australia.

```{r import}

# Import: Indigenous Status by SA2 Level for each state (2011 Census)
sa2Data2011 <- importSA2Data("2011")

# Import: SA2 Level by Indigenous Status, Sex, Age in 10 year blocks, and Weekly Personal Income (2011 Census)
census2011 <- importCensusData("2011", "2011-Census-Analysis/data/2011_Census.csv", "D:/2011_Census.csv")
census2011$Year <- "2011"

# Import: Indigenous Status by SA2 Level for each state (2016 Census)
sa2Data2016 <- importSA2Data("2016")

# Import: SA2 Level by Indigenous Status, Sex, Age in 10 year blocks, and Weekly Personal Income (2016 Census)  
census2016 <- importCensusData("2016", "2016-Census-Analysis/data/2016_Census.csv", "D:/2016_Census.csv")
census2016$Year <- "2016"

# Create new variable for Personal Weekly Income because they are different for 2011 and 2016 Census
uniqueCensus2011 <- unique(census2011$Weekly.Personal.Income)
uniqueCensus2016 <- unique(census2016$Weekly.Personal.Income)
setdiff(uniqueCensus2011, uniqueCensus2016) # Weekly Personal Income Values in 2011 not in 2016
setdiff(uniqueCensus2016, uniqueCensus2011) # Weekly Personal Income Values in 2016 not in 2011
intersect(uniqueCensus2011, uniqueCensus2016) # Shared values

# Not applicable
# Nil Income
# Negative Income
# Not stated
# $1-$299 ($1-$199 & $200-$299 from 2011 data; $1-$149 & $150-$299 from 2016 data)
# $300-$399
# $400-$799 ($400-$599 & $600-$799 from 2011 data; $400-$499, $500-$649 & $650-$799 from 2016 data)
# $800-$999
# $1,000-$1,249
# $1,250-$1,499
# $1,500-$1,999 ($1,500-$1,999 from 2011 data; $1,500-$1,749 & $1,750-$1,999 from 2016 data)
# $2,000 or more ($2,000 or more from 2011 data; $2,000-$2,999 & $3,000 or more from 2016 data)
census2011$Income <- as.character(census2011$Weekly.Personal.Income)
census2011$Income[census2011$Income == "$1-$199" | census2011$Income == "$200-$299"] <- "$1-$299"
census2011$Income[census2011$Income == "$400-$599" | census2011$Income == "$600-$799"] <- "$400-$799"

census2016$Income <- as.character(census2016$Weekly.Personal.Income)
census2016$Income[census2016$Income == "$1-$149" | census2016$Income == "$150-$299"] <- "$1-$299"
census2016$Income[census2016$Income == "$400-$499" | census2016$Income == "$500-$649" | 
                    census2016$Income == "$650-$799"] <- "$400-$799"
census2016$Income[census2016$Income == "$1,500-$1,749" | census2016$Income == "$1,750-$1,999"] <- "$1,500-$1,999"
census2016$Income[census2016$Income == "$2,000-$2,999" | census2016$Income == "$3,000 or more"] <- "$2,000 or more"

# Merge 2011 and 2016 data into one census dataset
census <- rbind(census2011, census2016)
census$Year <- as.factor(census$Year)
census$Income <- as.factor(census$Income)
census$Weekly.Personal.Income <- NULL

# Aggregate rows that have been re-coded
attach(census)
census <- aggregate(Count ~ . , sum, data=census)
detach(census)

# Add dummy variables for State, Income, Sex and Age variables
states <- as.data.frame(dummy.code(census$State))
ages <- as.data.frame(dummy.code(census$Age))
incomes <- as.data.frame(dummy.code(census$Income))
census <- cbind(census, states, ages, incomes)
census$Male <- as.numeric(census$Sex == "Male")
#census$Over50Years <-

rm(uniqueCensus2011, uniqueCensus2016, states, ages, incomes, census2011, census2016)

summary(census)   # When transforming the data counts of zero were excluded
describe(census$Count, IQR=TRUE) 

# Create data set containing only the Indigenous population
censusIndigenous <- census[which(census$Indigenous == 1),]
censusIndigenous$Indigenous <- NULL
censusIndigenous$Indigenous.Status <- NULL
summary(censusIndigenous)   # When transforming the data counts of zero were excluded
describe(censusIndigenous$Count, IQR=TRUE) 

# Indigenous population data (2011 only)
censusIndigenous2011 <- censusIndigenous[which(censusIndigenous$Year == "2011"),] # 52391
censusIndigenous2011$Year <- NULL
censusIndigenous2011$SA2 <- NULL
censusIndigenous2011$Male <- NULL

attach(censusIndigenous2011)
censusIndigenous2011 <- aggregate(Count ~ . , sum, data=censusIndigenous2011)
detach(censusIndigenous2011)

# Indigenous population data (2016 only)
censusIndigenous2016 <- censusIndigenous[which(censusIndigenous$Year == "2016"),] # 
censusIndigenous2016$Year <- NULL
censusIndigenous2016$SA2 <- NULL
censusIndigenous2016$Male <- NULL

attach(censusIndigenous2016)
censusIndigenous2016 <- aggregate(Count ~ . , sum, data=censusIndigenous2016)
detach(censusIndigenous2016)

```

### SA2 Level (2011 Census)

```{r sa2_2011}

dim(sa2Data2011) # data frame dimensions
str(sa2Data2011) # structure of data
head(sa2Data2011)

summary(sa2Data2011)
describe(sa2Data2011[c(2:7)], IQR=TRUE) # Summary statistics of population counts in each SA2 area
  
count(sa2Data2011, 'State') # Number of SA2 areas in each state
sum(count(sa2Data2011, 'State')$freq) # Number of SA2 areas in Australia for 2011 Census

```

### 2011 Census Data

```{r census_2011}

census2011 <- census[which(census$Year == "2011"),]
dim(census2011) # data frame dimensions
str(census2011) # structure of data
head(census2011, n=5) 

unique(census2011$State) # Levels of State variables
unique(census2011$Indigenous.Status) # Levels of Indigenous Status variable
unique(census2011$Sex) # Levels of Sex variable
unique(census2011$Age) # Levels of Age variable
unique(census2011$Income) # Levels of Weekly Personal Income variable

summary(census2011)   # When transforming the data counts of zero were excluded
describe(census2011$Count, IQR=TRUE) 
  
sum(census2011$Count) # Number of people counted in 2011 Census
length(unique(census2011$SA2)) # Number of SA2 areas with population counts > 0
length(unique(sa2Data2011$SA2)) - length(unique(census2011$SA2)) # Number of SA2 areas with no population recorded

options(scipen=999) # Disable scientific notation
total <- sum(census2011$Count)
customFunction <- function(x) c(sum = sum(x), percent = (sum(x)/total)*100)

attach(census2011)

# Number of people counted in each state during 2011 Census
aggregate(Count ~ State , FUN = customFunction, data=census2011)

# Number of people by indigenous status
aggregate(Count ~ Indigenous.Status , FUN = customFunction, data=census2011)

# Number of people who are indigenous or not
aggregate(Count ~ Indigenous , FUN = customFunction, data=census2011)

# Number of people by sex
aggregate(Count ~ Sex, FUN = customFunction, data=census2011)

# Number of people by age range
aggregate(Count ~ Age, FUN = customFunction, data=census2011)

# Number of people by Weekly Personal Income
aggregate(Count ~ Income, FUN = customFunction, data=census2011)

# Number of people per state by indigenous status
aggregate(Count ~ Indigenous.Status + State, FUN = customFunction, data=census2011)

# Number of people per Indigenous Status by age range
aggregate(Count ~ Indigenous.Status + Age, FUN = customFunction, data=census2011)

# Number of people per Indigenous Status by Weekly Personal Income
aggregate(Count ~ Indigenous.Status + Income, FUN = customFunction, data=census2011)

detach(census2011)

rm(census2011, total)
options(scipen=0) # Enable scientific notation
  
```

### SA2 Level (2016 Census)

```{r sa2_2016}

dim(sa2Data2016) # data frame dimensions
str(sa2Data2016) # structure of data
head(sa2Data2016)

summary(sa2Data2016)
describe(sa2Data2011[c(2:7)], IQR=TRUE) # Summary statistics of population counts in each SA2 area
  
count(sa2Data2016, 'State') # Number of SA2 areas in each state
sum(count(sa2Data2016, 'State')$freq) # Number of SA2 areas in Australia for 2016 Census

```

### 2016 Census Data

```{r census_2016}

census2016 <- census[which(census$Year == "2016"),]
dim(census2016) # data frame dimensions
str(census2016) # structure of data
head(census2016, n=5) 

unique(census2016$State) # Levels of State variable
unique(census2016$Indigenous.Status) # Levels of Indigenous Status variable
unique(census2016$Sex) # Levels of Sex variable
unique(census2016$Age) # Levels of Age variable
unique(census2016$Income) # Levels of Weekly Personal Income variable

summary(census2016)   # When transforming the data counts of zero were excluded
describe(census2016$Count, IQR=TRUE) 
  
sum(census2016$Count) # Number of people counted in 2016 Census
length(unique(census2016$SA2)) # Number of SA2 areas with population counts > 0
length(unique(sa2Data2016$SA2)) - length(unique(census2016$SA2)) # Number of SA2 areas with no population recorded

options(scipen=999) # Disable scientific notation
total <- sum(census2016$Count)
customFunction <- function(x) c(sum = sum(x), percent = (sum(x)/total)*100)

attach(census2016)

# Number of people counted in each state during 2011 Census
aggregate(Count ~ State , FUN = customFunction, data=census2016)

# Number of people by indigenous status
aggregate(Count ~ Indigenous.Status , FUN = customFunction, data=census2016)

# Number of people who are indigenous or not
aggregate(Count ~ Indigenous , FUN = customFunction, data=census2016)

# Number of people by sex
aggregate(Count ~ Sex, FUN = customFunction, data=census2016)

# Number of people by age range
aggregate(Count ~ Age, FUN = customFunction, data=census2016)

# Number of people by Weekly Personal Income
aggregate(Count ~ Income, FUN = customFunction, data=census2016)

# Number of people per state by indigenous status
aggregate(Count ~ Indigenous.Status + State, FUN = customFunction, data=census2016)

# Number of people per Indigenous Status by age range
aggregate(Count ~ Indigenous.Status + Age, FUN = customFunction, data=census2016)

# Number of people per Indigenous Status by Weekly Personal Income
aggregate(Count ~ Indigenous.Status + Income, FUN = customFunction, data=census2016)

detach(census2016)

rm(census2016, total, customFunction)
options(scipen=0) # Enable scientific notation

```

# Plots of Indigenous Data

```{r Plots}

# TODO: 2011 Census Data
plot(sa2Data2011$State, main="Number of SA2 Levels per State", ylab="SA2 Levels")
boxplot(Count ~ Age, data = censusIndigenous2011)
boxplot(Count ~ Income, data = censusIndigenous2011)

pairs(~Age+Income+Sex+Count, data=censusIndigenous2011, main="Simple Scatterplot Matrix")

#library(lattice)
#splom(censusIndigenous2011[c(2,10,11,12,13,14,15,17)], groups=censusIndigenous2011$Indigenous.Status, data=censusIndigenous2011,
#  	panel=panel.superpose)

# TODO: 2016 Census Data
plot(sa2Data2016$State, main="Number of SA2 Levels per State", ylab="SA2 Levels")
boxplot(Count ~ Age, data = censusIndigenous2016)
boxplot(Count ~ Income, data = censusIndigenous2016)

# TODO: 2011 and 2016 Census Data
#boxplot(Count ~ Age, data = census)
#boxplot(Count ~ Income, data = census)
#boxplot(Count ~ Indigenous, data = census)

```


# Correlation

In this section the correlation between variables for the Indigenous population are examined.

```{r Correlation}

# https://stats.stackexchange.com/questions/108007/correlations-with-unordered-categorical-variables
# https://stats.stackexchange.com/questions/119835/correlation-between-a-nominal-iv-and-a-continuous-dv-variable/124618#124618
  
# Correlation for 2011 Census data only
  
  #library(corrgram)
  #corrgram(censusIndigenous2011, order=TRUE, lower.panel=panel.shade,
  #         upper.panel=NULL, text.panel=panel.txt, cor.method = "spearman",
  #         main="Correlation of Numerical Variables")
  
  #corrgram(censusIndigenous2011, order=TRUE, lower.panel=panel.shade,
  #         upper.panel=NULL, text.panel=panel.txt, cor.method = "pearson",
  #         main="Correlation of Numerical Variables")
  
  nums <- sapply(censusIndigenous2011, is.numeric)
  numeric_data <- censusIndigenous2011[ , nums]

  # calculate correlation matrix
  spearman <- cor(numeric_data, use="complete.obs", method="spearman") # can be used when outliers present
  pearson <- cor(numeric_data, use="complete.obs", method="pearson")  # assumes normality
  
  # summarise the correlation matrix
  print(spearman)
  print(pearson)
  
# Correlation for 2011 and 2016 Data

  #nums <- sapply(censusIndigenous, is.numeric)
  #umeric_data <- censusIndigenous[ , nums]
  
  # calculate correlation matrix
  #spearman <- cor(numeric_data, use="complete.obs", method="spearman") # can be used when outliers present
  #pearson <- cor(numeric_data, use="complete.obs", method="pearson")  # assumes normality
  
  # summarise the correlation matrix
  #print(spearman)
  #print(pearson)
  
  rm(nums, numeric_data, spearman, pearson)

```

# Normality Tests

In this section the normality of count data for the Indigenous population (2011) is examined.

```{r Normality}

# https://www.r-bloggers.com/normality-tests-for-continuous-data/
# http://stat.ethz.ch/R-manual/R-devel/library/stats/html/shapiro.test.html

data <- censusIndigenous2011$Count
sample <- sample(data, size = 5000)
hist(sample)

shapiro.test(sample) # Sample size must be between 3 and 5000

library(nortest)
# The A-D test is susceptible to extreme values, and may not give good results for very large data sets
ad.test(data) # very low p-value indicates that the distribution is not normal

qqnorm(data)
qqline(data, col = "red")

rm(data, sample)

```

# Regression

Multiple linear regression is used to get a better understanding of which variables are important in estimating the number of indigenous population.

```{r Regression}

# https://www.statmethods.net/stats/regression.html
# https://data-flair.training/blogs/r-nonlinear-regression/

# Stepwise Regression
library(MASS)
fit <- lm(Count ~ State + Sex + Age + Income + City + InnerRegional + OuterRegional + Remote + VeryRemote + 
            MigratoryOffshoreShipping + NoUsualAddress, data=censusIndigenous2011)
step <- stepAIC(fit, direction="both")
step$anova # display results


# All Subsets Regression
library(leaps)

attach(censusIndigenous2011)
leaps<-regsubsets(Count ~ State + Sex + Age + Income + City + InnerRegional + OuterRegional + Remote + VeryRemote + 
            MigratoryOffshoreShipping + NoUsualAddress, data=censusIndigenous2011, nbest=10)#, really.big=T)
detach(censusIndigenous2011)

# view results 
summary(leaps)

# plot a table of models showing variables in each model.
# models are ordered by the selection statistic.
plot(leaps,scale="r2")

# plot statistic by subset size 
#library(car)
#subsets(leaps, statistic="rsq")

rm(fit, step, leaps)

```

# Small Area Estimation

```{r Estimation}

```


